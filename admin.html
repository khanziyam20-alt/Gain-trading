<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Approval Center</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        .section-title { color: #38bdf8; margin-top: 40px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 12px; overflow: hidden; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; font-size: 0.8rem; text-transform: uppercase; }
        .approve-btn { background: #10b981; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .reject-btn { background: #ef4444; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; }
        .pending { background: #f59e0b; color: #000; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin Control Center</h1>

        <h2 class="section-title">Pending Deposit/Withdraw Requests</h2>
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="requestList">
                </tbody>
        </table>

        <h2 class="section-title">Manage Users & Profit Rates</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Balance</th>
                    <th>Profit Rate (%/s)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="userList">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your Config
        const firebaseConfig = {
            apiKey: "AIzaSyBMicn5UaGmlpyjqyvHndQAqpBTIl5KKTs",
            authDomain: "gain-trading.firebaseapp.com",
            projectId: "gain-trading",
            storageBucket: "gain-trading.firebasestorage.app",
            messagingSenderId: "158325829948",
            appId: "1:158325829948:web:004921f55b11297c596e39"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "khanziyam20@gmail.com";

        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== ADMIN_EMAIL) {
                window.location.href = "index.html";
            } else {
                loadRequests();
                loadUsers();
            }
        });

        // Load Deposit/Withdraw Requests
        function loadRequests() {
            onSnapshot(collection(db, "requests"), (snapshot) => {
                const list = document.getElementById('requestList');
                list.innerHTML = "";
                snapshot.forEach((reqDoc) => {
                    const req = reqDoc.data();
                    const id = reqDoc.id;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${req.userName}<br><small>${req.userEmail}</small></td>
                        <td><span class="status-badge pending">${req.type}</span></td>
                        <td>$${req.amount}</td>
                        <td>
                            <button class="approve-btn" onclick="handleRequest('${id}', '${req.userId}', ${req.amount}, '${req.type}')">Approve</button>
                            <button class="reject-btn" onclick="rejectRequest('${id}')">Reject</button>
                        </td>
                    `;
                    list.appendChild(tr);
                });
            });
        }

        // Approve Request and Update Balance
        window.handleRequest = async (reqId, userId, amount, type) => {
            const userRef = doc(db, "users", userId);
            try {
                // If Deposit, add money. If Withdraw, subtract.
                const balanceChange = type === "Deposit" ? amount : -amount;
                
                await updateDoc(userRef, {
                    walletBalance: increment(balanceChange)
                });
                
                // Remove request after approval
                await deleteDoc(doc(db, "requests", reqId));
                alert(type + " Approved Successfully!");
            } catch (e) { alert("Error: " + e.message); }
        };

        window.rejectRequest = async (id) => {
            if(confirm("Reject this request?")) {
                await deleteDoc(doc(db, "requests", id));
            }
        };

        // Load Users for Profit Rate control
        function loadUsers() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                snapshot.forEach((uDoc) => {
                    const data = uDoc.data();
                    const id = uDoc.id;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data.name}</td>
                        <td>$${data.walletBalance.toFixed(2)}</td>
                        <td><input type="number" id="rate-${id}" value="${data.profitRate}" step="0.01" style="width:60px"></td>
                        <td><button class="approve-btn" onclick="updateRate('${id}')">Update Rate</button></td>
                    `;
                    list.appendChild(tr);
                });
            });
        }

        window.updateRate = async (id) => {
            const newRate = parseFloat(document.getElementById(`rate-${id}`).value);
            await updateDoc(doc(db, "users", id), { profitRate: newRate });
            alert("Rate Updated!");
        };
    </script>
</body>
</html>
