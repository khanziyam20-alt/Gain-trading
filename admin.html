<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #38bdf8; --bg: #020617; --card: #0f172a; --accent: #10b981; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: white; padding: 20px; margin: 0; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        h2 { color: var(--primary); font-size: 1.2rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Plan Editor Grid */
        .plan-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input { background: #020617; border: 1px solid #1e293b; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #64748b; font-size: 0.8rem; padding: 10px; text-transform: uppercase; }
        td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-approve { background: var(--accent); color: white; }
        .btn-update { background: var(--primary); color: #020617; width: 100%; margin-top: 15px; }
    </style>
</head>
<body>

    <h2>Admin Command Center</h2>

    <div class="stat-card">
        <h2>Update Money Plan Chart</h2>
        <div class="plan-grid">
            <div><label style="font-size: 0.7rem;">Invest (₹)</label><input type="number" id="planInv"></div>
            <div><label style="font-size: 0.7rem;">Profit (₹)</label><input type="number" id="planProf"></div>
            <div><label style="font-size: 0.7rem;">Percent (%)</label><input type="number" id="planPerc"></div>
            <div><label style="font-size: 0.7rem;">Days</label><input type="number" id="planDays"></div>
        </div>
        <button class="btn btn-update" onclick="updateGlobalPlan()">Save Plan for All Users</button>
    </div>

    <div class="stat-card">
        <h2>Pending Requests</h2>
        <div id="requestList">Loading...</div>
    </div>

    <div class="stat-card">
        <h2>All Users</h2>
        <div id="userList">Loading...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBMicn5UaGmlpyjqyvHndQAqpBTIl5KKTs",
            authDomain: "gain-trading.firebaseapp.com",
            projectId: "gain-trading",
            storageBucket: "gain-trading.firebasestorage.app",
            messagingSenderId: "158325829948",
            appId: "1:158325829948:web:004921f55b11297c596e39"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Fetch Current Plan Data
        const planRef = doc(db, "plans", "current_plan");
        onSnapshot(planRef, (ds) => {
            if(ds.exists()) {
                const d = ds.data();
                document.getElementById('planInv').value = d.invest;
                document.getElementById('planProf').value = d.profit;
                document.getElementById('planPerc').value = d.percent;
                document.getElementById('planDays').value = d.days;
            }
        });

        window.updateGlobalPlan = async () => {
            await setDoc(planRef, {
                invest: parseFloat(document.getElementById('planInv').value),
                profit: parseFloat(document.getElementById('planProf').value),
                percent: parseFloat(document.getElementById('planPerc').value),
                days: parseInt(document.getElementById('planDays').value)
            });
            alert("Money Plan Updated Successfully!");
        };

        // REQUESTS LOGIC
        onSnapshot(collection(db, "requests"), (snap) => {
            const list = document.getElementById('requestList');
            list.innerHTML = "<table><tr><th>Type</th><th>Amount</th><th>Action</th></tr>";
            snap.forEach(d => {
                const r = d.data();
                if(r.status === 'pending') {
                    list.innerHTML += `<tr>
                        <td>${r.type}</td><td>₹${r.amount}</td>
                        <td><button class="btn btn-approve" onclick="approveReq('${d.id}', '${r.userId}', ${r.amount}, '${r.type}')">Approve</button></td>
                    </tr>`;
                }
            });
            list.innerHTML += "</table>";
        });

        window.approveReq = async (reqId, uid, amt, type) => {
            const uRef = doc(db, "users", uid);
            const change = type === 'Deposit' ? amt : -amt;
            await updateDoc(uRef, { walletBalance: increment(change) });
            await updateDoc(doc(db, "requests", reqId), { status: 'approved' });
            alert("Approved!");
        };

        // USERS LOGIC
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('userList');
            list.innerHTML = "<table><tr><th>User</th><th>Profit %</th><th>Action</th></tr>";
            snap.forEach(d => {
                const u = d.data();
                list.innerHTML += `<tr>
                    <td>${u.name}<br><small>${u.walletBalance.toFixed(1)}</small></td>
                    <td><input type="number" id="rate-${d.id}" value="${u.profitRate}" style="width:60px"></td>
                    <td><button class="btn btn-approve" onclick="updateRate('${d.id}')">Set</button></td>
                </tr>`;
            });
            list.innerHTML += "</table>";
        });

        window.updateRate = async (id) => {
            const newRate = parseFloat(document.getElementById('rate-'+id).value);
            await updateDoc(doc(db, "users", id), { profitRate: newRate });
            alert("Rate Updated!");
        };
    </script>
</body>
</html>
